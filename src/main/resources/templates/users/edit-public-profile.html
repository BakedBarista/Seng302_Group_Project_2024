<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang='en' xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Edit My Profile | Pollinat*r</title>

  <!-- This needs to be here for Bootstrap and general CSS imports -->
  <th:block th:insert="~{fragments/general.html :: headerfiles}"></th:block>
</head>
<body>
<nav th:replace="~{fragments/navbar :: navbar}"></nav>


<main class="main-container">
    <div class="modal fade" id="plantSelectorModal" tabindex="0" aria-labelledby="plantSelectorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" id="plantSelectorModalContent">
                <div class="modal-header">
                    <h5 class="modal-title" id="plantSelectorModalLabel">Select Favourite Plant</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form class="input-group w-100" th:action="@{users/edit-public-profile/search}" method="post" id="searchForm">
                        <input type="text" class="form-control" placeholder="Search plant" id="searchField"
                               aria-label="Search plants" aria-describedby="button-addon" name="search" th:value="${previousSearch}">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="submit" id="button-addon" onclick="showSearchResults()">
                                <img th:src="@{/icons/search-icon.svg}" alt="" width="20" height="25" />
                            </button>
                        </div>
                    </form>

                    <div id="searchResults" class="select-container"></div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" id="submit-button" class="btn btn-primary btn-sm">Submit</button>
                </div>

                    <script th:src="@{/js/autocomplete.js}"></script>
                    <script th:src="@{/js/searchPlantFavourite.js}"></script>
                </div>

            </div>
        </div>
    </div>

  <div class="card border-top-0">
      <form th:action="@{/users/edit-public-profile}" method="post" enctype="multipart/form-data" th:object="${editUserDTO}" novalidate>
          <div class="card-img-top img-fluid fixed-height mb-4 position-relative">
              <div class="position-relative">
                  <label for="bannerImage" class="position-absolute top-0 end-0 p-2" style="cursor: pointer;">
                      <img id="banner_image_button_label" th:src="@{/icons/trans-plus.svg}" alt="+" tabindex="1"/>
                  </label>
                  <input id="bannerImage"
                         name="bannerImage"
                         class="d-none"
                         type="file"
                         accept=".png,.jpg,.jpeg,.svg"
                         tabindex="1"/>
                  <img id="bannerPreview"
                       class="card-img-top img-fluid fixed-height mb-4"
                       th:src="@{'/users/' + ${userId} + '/profile-banner'}"
                       alt="profile banner"/>
                  <span id="editProfileBannerError" class="invalid-feedback"></span>
              </div>
          </div>
          <div>
              <label for="image" class="position-absolute top-0 end-0 public-profile-picture-plus-button-padding me-2" style="cursor: pointer;">
                  <img id="image_button_label" th:src="@{/icons/trans-plus.svg}" alt="+" tabindex="2"/>
              </label>
              <input id="image"
                     name="image"
                     class="d-none"
                     type="file"
                     accept=".png,.jpg,.jpeg,.svg"
                     tabindex="2"/>
              <img id="preview"
                   class="public-profile-picture position-absolute top-0 end-0 justify-content-md-center public-profile-picture-padding me-2"
                   th:src="@{'/users/' + ${userId} + '/profile-picture'}"
                   width="200"
                   height="200"
                   alt="Profile Picture"/>
              <span id="editProfilePictureError" class="invalid-feedback text-center"></span>
          </div>

          <div class="m-4 mt-0">
              <div class="d-flex flex-column">
                  <div class="m-2 mt-3">
                      <span th:if="${name != null && name.length() >= 12}"><span class="d-sm-none d-flex mt-5"></span></span>
                      <h2 class="mb-3">[[${name}]]</h2>
                      <h5 class="mb-1 about-me">
                          <label for="description"
                                 class="form-label"
                                 th:classappend="${#fields.hasErrors('description')} or ${profanity != null} ? ' is-invalid'">
                              About Me...
                          </label>
                      </h5>
                      <textarea rows="3"
                                id="description"
                                type="text"
                                class="form-control"
                                tabindex="3"
                                th:classappend="${#fields.hasErrors('description')} or ${profanity != null} ? ' is-invalid'"
                                th:text="${editUserDTO.description}" th:name="description">
                      </textarea>
                      <div class="invalid-feedback">
                          <div th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
                          <div th:if="${profanity != null}" th:text="${profanity}"></div>
                      </div>
                  </div>
              </div>
          </div>
          <div class="card m-4 p-4 mt-1 border-0 rounded-3 shadow-sm " style="background-color: #F9EFCC">
              <div class="d-flex">
                  <h4>My Favourite Garden</h4>
                  <a class="btn btn-change ms-auto mb-2" >
                      <img th:src="@{/icons/edit.svg}"
                           aria-hidden=""
                           alt="edit"
                           width="20"
                           height="20" /> Change
                  </a>
              </div>
              <th:block th:insert="~{fragments/favourite-garden.html :: favourite-garden}"></th:block>
          </div>

          <div class="card m-4 p-4 mt-1 border-0 rounded-3 shadow-sm" style="background-color: #F9EFCC">
              <h4>My Favourite Plants...</h4>
              <div class="ms-5 me-5">
                  <div class="d-flex flex-wrap flex-md-nowrap">
                      <!-- please remove hard coded stuff when you can :) -->

                      <!-- for each on favourite plants-->
                      <!-- non-empty card -->
                      <div class="card p-2 me-3 mb-3 border-0 rounded-3 d-flex shadow-sm public-profile-plant-card bg-primary-temp">
                          <!-- place holder image -->
                          <img
                                  class="mx-auto d-block pt-1"
                                  th:src="@{'/plants/10/plant-image'}"
                                  width="120"
                                  height="120"
                                  alt="profile picture"
                          />
                          <h4 class="pt-2 ps-2">Banana</h4>
                      </div>

                      <!-- empty card -->
                      <div class="card p-2 me-3 mb-3 border-0 rounded-3 shadow-sm
                      public-profile-plant-card justify-content-center card-wiggle bg-primary-grey"
                           onclick="openPlantSelectorModal(1)">
                          <img th:src="@{/icons/create-mustard-grey.svg}"
                               class="mx-auto d-block"
                               aria-hidden="true"
                               alt="empty-favourite"
                               width="50"
                               height="50" />
                      </div>

                      <!-- empty card -->
                      <div class="card p-2 me-3 mb-3 border-0 rounded-3 shadow-sm
                      public-profile-plant-card justify-content-center card-wiggle bg-primary-grey"
                           onclick="openPlantSelectorModal(1)">
                          <img th:src="@{/icons/create-mustard-grey.svg}"
                               class="mx-auto d-block"
                               aria-hidden="true"
                               alt="empty-favourite"
                               width="50"
                               height="50" />
                      </div>
                  </div>
              </div>
          </div>
        
        <!-- Button Container with Adjusted Spacing -->
        <div class="d-flex justify-content-end px-4 mb-4">
          <a th:href="@{/users/public-profile}" class="btn btn-outline-secondary me-2" tabindex="4">Cancel</a>
          <button class="btn btn-primary" tabindex="5">Submit</button>
        </div>
      </form>
  </div>
</main>
<th:block th:insert="~{fragments/general.html :: bs-scripts}"></th:block>

<script>

openPlantSelectorModal = (index) => {
    const modal = new bootstrap.Modal(document.getElementById("plantSelectorModal"))
    modal.show()
}


    /** @type {HTMLInputElement} */
    const editProfileImageInput = document.getElementById("image");
  /** @type {HTMLSpanElement} */
  const editProfilePictureError = document.getElementById("editProfilePictureError");
  /** @type {HTMLInputElement} */
  const bannerImageInput = document.getElementById("bannerImage");
  /** @type {HTMLSpanElement} */
  const bannerImageError = document.getElementById("editProfileBannerError");

  const VALID_MIME_TYPES = ["image/png", "image/jpeg", "image/svg+xml"];
  const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

  // buttons pressable on tab
  const bannerLabel = document.getElementById('banner_image_button_label');
  const bannerFileInput = document.getElementById('bannerImage');
  bannerLabel.addEventListener("keypress", bannerFileInput.click)

  const label = document.getElementById('image_button_label');
  const fileInput = document.getElementById('image');
  label.addEventListener("keypress", fileInput.click)

  /**
   * Validates the selected file and updates the preview.
   * @param {HTMLInputElement} inputElement - The input element for file selection.
   * @param {HTMLImageElement} previewElement - The image element for preview.
   * @param {HTMLSpanElement} errorElement - The span element for displaying error messages.
   */
  function handleFileSelection(inputElement, previewElement, errorElement) {
    const file = inputElement.files[0];
    let hasError = false;

    if (!file) {
      return;
    }

    errorElement.textContent = "";
    errorElement.style.display = "none";

    if (!VALID_MIME_TYPES.includes(file.type)) {
      errorElement.style.display = "block";
      errorElement.textContent = "Image must be of type png, jpg or svg";
      hasError = true;
      inputElement.value = null;
      return;
    }

    if (file.size > MAX_FILE_SIZE) {
      errorElement.style.display = "block";
      errorElement.textContent = "File size must be less than 10MB";
      hasError = true;
      inputElement.value = null;
      return;
    }

    const reader = new FileReader();
    reader.onload = function () {
      previewElement.src = reader.result;
      previewElement.style.display = "block";
    };
    reader.readAsDataURL(file);
  }

  // Apply the function to profile picture input
  editProfileImageInput.addEventListener("change", () => {
    handleFileSelection(editProfileImageInput, document.getElementById("preview"), editProfilePictureError);
  });

  // Apply the function to banner image input
  bannerImageInput.addEventListener("change", () => {
    handleFileSelection(bannerImageInput, document.getElementById("bannerPreview"), bannerImageError);
  });
</script>
</body>

</html>